## 拓展功能接口规范文档（更新版）

### 统一返回结构 AuthResult 
•	ok(bool): 本次调用是否成功（true 才能读取后续字段）
•	userId(int): 成功后标识唯一用户（服务端对接房间/日志/权限都靠它）
•	role(string): 决定能否 CREATE/JOIN、是否可踢人等（"factory"|"expert"|"admin"|"auditor"）
•	token(string): 会话凭证（之后请求不再传密码，带 token 即可）；服务端可设置 2h 过期
•	error(string): 失败原因码（让客户端做精确提示；服务端也可据此打点）
•	~~approved(bool): 用户是否已通过审核（true=已审核，false=待审核）~~ **【已删除】**

### 服务端 C++ 接口（签名与返回约定）

#### 认证相关接口
•	authenticateUser(username, password, role) → AuthResult
•	成功: {ok:true, userId, role, token}
•	失败: {ok:false, error: USER_NOT_FOUND | BAD_PASSWORD | ROLE_MISMATCH | DB_ERROR}
•	validateToken(token) → AuthResult
•	成功: {ok:true, userId, role}
•	失败: {ok:false, error: TOKEN_INVALID | TOKEN_EXPIRED | DB_ERROR}

#### 注册相关接口
•	registerUser(username, password, email, company, requestedRole) → AuthResult
•	成功: {ok:true, userId, role, status:"pending"}
•	失败: {ok:false, error: USERNAME_EXISTS | INVALID_ROLE | DB_ERROR}
•	isUsernameExists(username) → bool
•	成功: true（用户名已存在）/ false（用户名可用）
•	失败: false

#### 审核相关接口 **【新增】**
•	getPendingUser() → vector<UserInfo> **【修改：函数名从getPendingUsers改为getPendingUser】**
•	成功: 返回所有待审核用户列表
•	失败: 返回空列表
•	getAllUsers() → vector<UserInfo> **【新增】**
•	成功: 返回所有用户列表
•	失败: 返回空列表
•	approveUser(userId, adminId) → bool **【新增】**
•	成功: true
•	失败: false
•	rejectUser(userId, adminId) → bool **【新增】**
•	成功: true
•	失败: false

### 统一错误码定义
•	USER_NOT_FOUND: 用户不存在
•	BAD_PASSWORD: 密码错误
•	ROLE_MISMATCH: 角色不匹配
•	~~NOT_APPROVED: 用户未通过审核~~ **【已删除】**
•	TOKEN_INVALID: token无效
•	TOKEN_EXPIRED: token过期
•	USERNAME_EXISTS: 用户名已存在
•	INVALID_ROLE: 无效角色
•	PERMISSION_DENIED: 权限不足
•	DB_ERROR: 数据库错误

### 用户角色权限定义
•	factory: 工厂用户，可以创建房间，可以加入房间
•	expert: 专家用户，只能加入房间，不能创建房间
•	admin: 管理员，可以审核用户，可以管理所有功能
•	auditor: 审计员，只能查看日志，不能参与会议

### 数据库表结构统一 **【修改】**
•	users表字段: id, username, password, role, email, company, ~~approved,~~ status, reviewed_by **【删除approved字段】**
•	user_tokens表字段: token, user_id, role, expire_time
•	字段类型: id(INT), username(VARCHAR(50)), password(VARCHAR(255)), role(ENUM), email(VARCHAR(100)), company(VARCHAR(100)), ~~approved(BOOLEAN),~~ status(ENUM), reviewed_by(INT) **【删除approved字段类型】**
•	说明: reviewed_by字段直接存储users表的id，表示哪个管理员审核的

### 客户端界面统一

#### 登录界面
•	用户名输入框、密码输入框、角色选择下拉框、登录按钮、错误提示标签
•	登录失败时显示具体错误：用户不存在/密码错误/角色不匹配

#### 注册界面
•	用户名输入框、密码输入框、邮箱输入框（可选）、公司输入框（可选）、角色选择下拉框、注册按钮、错误提示标签
•	注册成功后显示"申请已提交，请等待管理员审核"

#### 管理员审核界面 **【新增】**
•	用户列表表格（显示：ID、用户名、邮箱、公司、申请角色、状态、审核人ID）
•	状态筛选下拉框（全部/待审核/已审核/已拒绝）
•	审核通过按钮、审核拒绝按钮
•	实时刷新功能

### 网络协议统一
•	认证消息类型: AUTH = 20, AUTH_OK = 21, AUTH_ERR = 22
•	注册消息类型: REGISTER = 23, REGISTER_OK = 24, REGISTER_ERR = 25
•	审核消息类型: GET_PENDING_USERS = 26, APPROVE_USER = 27, REJECT_USER = 28 **【新增】**
•	心跳消息类型: HEARTBEAT = 10, HEARTBEAT_ACK = 11
•	消息格式: $ + MSG_TYPE + IP + MSG_SIZE + DATA + #

### 配置参数统一
•	数据库连接: HOST="39.106.12.91", USER="qtuser", PASS="QtPassw0rd!", DB_NAME="dongRuanSystem", PORT=3306
•	Token过期时间: 2小时
•	心跳间隔: 5秒
•	心跳超时: 15秒
•	重连间隔: 1秒, 2秒, 4秒, 最大15秒

### 日志格式统一
•	登录日志: [时间] [用户ID] [用户名] [角色] [IP地址] [操作] [结果]
•	注册日志: [时间] [用户ID] [用户名] [申请角色] [IP地址] [操作] [结果]
•	审核日志: [时间] [管理员ID] [被审核用户ID] [操作] [结果] **【新增】**
•	错误日志: [时间] [错误类型] [错误描述] [堆栈信息]

### 业务流程统一

#### 注册流程
1. 用户填写注册信息（邮箱、公司为可选）
2. 客户端验证表单数据
3. 发送registerUser请求
4. 服务端检查用户名是否存在
5. 插入用户记录（~~approved=false,~~ status="pending"） **【删除approved字段设置】**
6. 返回注册结果

#### 审核流程 **【新增】**
1. 管理员登录系统
2. 查看待审核用户列表
3. 选择用户进行审核
4. 点击通过/拒绝按钮
5. 更新用户状态（~~approved=true/false,~~ status="approved"/"rejected", reviewed_by=adminId） **【删除approved字段更新】**

#### 登录流程
1. 用户输入用户名密码和选择角色
2. 发送authenticateUser请求
3. 服务端验证用户名密码和角色
4. ~~检查用户是否已审核（approved字段）~~ **【删除审核检查】**
5. 生成token并返回
6. 客户端保存token用于后续请求

### 安全要求统一
•	密码传输加密
•	Token安全生成（32位随机字符串）
•	SQL注入防护
•	权限验证（只有admin可以审核）
•	输入数据验证和过滤