# 工业现场远程专家支持系统 项目功能完成情况

## 功能模块完成度统计

| 模块名称及完成度                                   | 用到的技术点                                                                                 | 创新点                                                               | 责任人                                                         | 备注                                                                                  |
| -------------------------------------------------- | -------------------------------------------------------------------------------------------- | -------------------------------------------------------------------- | -------------------------------------------------------------- | ------------------------------------------------------------------------------------- |
| **音视频文字通信基础框架** <br />已完成     | • Qt Widgets框架<br />• TCP Socket通信 <br />• 多进程架构 <br />• 消息队列机制           | • 结构化消息协议设计<br />• 多进程房间管理 <br />• 实时音视频传输 | 原有代码                                                       | 基础的文字/视频/音频发送接收，队列，UI界面，以及协议定义                              |
| **心跳机制与自动重连** <br /> 调试中        | • Qt定时器机制<br />• TCP Socket通信 <br />• 多进程架构 <br />• 连接状态管理             | • 智能重连机制<br />• 进程间心跳处理 <br />• 低延迟响应           | 丁予晴（服务端）、曹凯淇（客户端）                             | 客户端每5秒发送心跳，服务端10秒超时检测，支持进程间心跳处理和自动重连                 |
| **Token会话凭证与身份认证** <br /> 已完成  | • MySQL数据库设计<br />• C++ MySQL API <br />• SHA256密码加密<br />• Token随机生成与校验 | • 无密码会话认证<br />• 2小时自动过期 <br />• SQL预处理防注入     | 白钦宇（生成/存储）、朱写（验证/权限）                         | 实现完整的用户认证体系，支持Token验证和无密码会话认证                                 |
| **用户登录注册与管理员审核** <br />调试中   | • Qt信号槽机制<br />• 网络通信TCP协议 <br />• JSON数据交换 <br />• 数据库事务            | 注册后需管理员审核的流程，<br />增强了系统安全性与管理可控性         | 朱写（用户登录注册）、邓清月（管理员客户端）、白钦宇（服务端） | 注册/登录UI界面已完成，服务端数据库操作接口已实现，登录注册、管理员审核界面后端联调中 |
| **SSH反向隧道与云部署** <br /> 已完成      | • SSH反向隧道<br />• autossh自动重连 <br />• 云服务器配置 <br />• 安全组管理             | • 内网穿透技术<br />• 自动隧道重连                                 | 白钦宇（云服务器）、邓清月（ssh反向隧道）                      | 配置SSH反向隧道，实现互联网客户端访问虚拟机服务端                                     |
| **实时显示工厂设备信息** <br />待完成       |                                                                                              |                                                                      | 白钦宇                                                         |                                                                                       |
| **音视频通信功能优化**<br />待完成           | •Opus音频编码库<br />•H.264视频编码库                                                      |                                                                      |                                                                |                                                                                       |
| **多画面视频会议系统**<br />待完成           |                                                                                              |                                                                      |                                                                |                                                                                       |

---

## 详细功能说明

### 1. **音视频文字通信基础框架**

**功能说明** ：

* 实现了基于 Qt Widgets 的客户端UI，支持文字、视频、音频的发送与接收；
* 服务端采用多进程房间架构，通过消息队列机制进行消息转发。

### 2. 心跳机制与自动重连  已完成

**功能说明** ：

* **客户端** ：每5秒发送心跳包（HEARTBEAT），10秒无响应则触发重连，支持指数退避重连策略；
  * 定时发送机制：使用 QTimer，通过 sendHeartbeat 周期发送心跳包；连接建立与重连成功后启动，使用 Qt::UniqueConnection 避免重复连接。
  * 心跳包结构与发送：遵循 $_msgtype_ip_size_data_#；消息类型 HEARTBEAT(10)，数据大小 0；记录 _lastHeartbeatSentTime。
  * 心跳响应处理：接收线程监听 HEARTBEAT_ACK(11)，更新时间戳并计算 RTT；具备包校验与无效数据跳过。
  * 超时检测与重连：超过 10 秒无响应触发重连；停止/重启定时器并恢复会话状态。
* **服务端** ：接收心跳并回复 HEARTBEAT_ACK，维护连接状态，超时自动断开。
  * 在 room.cpp 子进程内直接处理 HEARTBEAT，即时返回 HEARTBEAT_ACK（不经发送队列，低延迟），附带 0.0.0.0 IP 以便调试。
  * 支持主/子进程心跳处理，解决创建会议后连接迁移导致的心跳丢失问题。

**技术实现**:

* Qt 定时器（QTimer）
* TCP Socket 状态管理
* 多进程心跳处理（主进程与子进程均可处理）

**创新特点**:

* 进程间心跳处理机制，避免子进程接管后心跳失效
* 低延迟响应与智能重连策略

### 3. Token会话凭证与身份认证  已完成

**功能说明** ：

* 创建 `dongRuanSystem` 数据库，设计 `users` 和 `user_tokens` 表。

  * users 表包含用户ID、用户名、加密密码、角色、邮箱、公司、审核状态、审核人ID等字段。
  * user_tokens 表，存储用户登录会话 token、过期时间、角色等信息，支持会话鉴权
* 注册与登录

  * 注册时先检查用户名是否存在，校验角色合法性，密码用 SHA256 加密后存储。
  * 登录时校验用户名和密码，成功后生成随机 token，插入 user_tokens 表，设置 2 小时过期。
* Token 生成与验证

  * 校验 token 是否存在及是否过期，返回用户ID和角色等信息，实现无密码会话认证。
* 用户信息查询

  * getPendingUser 查询所有待审核用户。
  * getAllUsers 查询所有用户信息。

**技术实现**:

* MySQL 数据库设计与操作
* C++ MySQL API
* SHA256 密码加密
* Token 随机生成与校验
* SQL 预处理防注入

**创新特点**:

* 无密码会话认证（Token机制）
* 2小时自动过期策略
* 审核流程自动化，支持多角色权限控制

### 4. 用户登录注册与管理员审核  调试中

**功能说明** ：

* 登录/注册流程（客户端）

  * 通过 sendLoginData / sendRegisterData 组装表单数据（username|password|[email]|role），发送 AUTH/REGISTER 类型消息。
  * 采用信号槽反馈 UI（loginSuccess/loginFailed、registerSuccess/registerFailed），成功后根据角色跳转对应界面。
  * UI 采用深色主题与 QStackedWidget 登录/注册页切换；自动清空敏感输入与错误提示。
* 角色选择与权限控制

  * 客户端携带 factory/expert/admin 角色；服务端验证后返回角色，客户端据此控制“创建/加入会议”“管理员面板”等入口可见性。
* 管理员审核（AdminPanel）

  * 管理员审核页面支持待审核列表刷新、通过/拒绝、状态筛选。
  * 管理员可通过 approveUser 和 rejectUser 接口审核用户，自动记录审核人ID和状态。

**技术实现**:

* Qt 信号槽机制
* TCP 网络通信
* JSON 数据交换
* 数据库事务处理

**创新特点**:

* 注册后需管理员审核，增强系统安全性
* 角色与业务流程深度集成，权限控制严格

### 5. SSH反向隧道与云部署  已完成

**功能说明** ：

* 通过 SSH 反向隧道实现内网穿透，支持互联网任意客户端经由云服务器访问部署在虚拟机内的服务端。
* 云服务器关键配置：

  * GatewayPorts yes ：允许远程端口转发
  * AllowTcpForwarding yes： 允许 SSH 的 TCP 端口转发功能
* 服务端运行：./app 0.0.0.0 8080 3 2 启动后验证监听。
* 建立隧道（autossh）：

  * autossh -M 20000 -N -R 0.0.0.0:8080:127.0.0.1:8080 root@云服务器 -i `<pem>`
  * 验证云端 0.0.0.0:8080 监听；Windows 客户端以“云服务器IP:8080”直接连接。

**技术实现**:

- 配置SSH反向隧道，实现内网穿透
- 使用autossh工具实现自动隧道重连
- 云服务器配置GatewayPorts和AllowTcpForwarding
- 安全组管理，开放8080端口访问

**创新特点**:

* 无需公网IP即可实现远程访问
* 自动隧道维护与重连机制

### 6.实时显示工厂设备信息 待完成

---

## 技术栈总结

### 前端技术

- **Qt Framework**: 跨平台GUI开发
- **信号槽机制**: UI交互与业务逻辑解耦
- **TCP Socket**: 网络通信
- **定时器机制**: 心跳检测

### 后端技术

- **C++**: 服务端开发语言
- **MySQL**: 数据持久化存储，dongRuanSystem数据库
- **C++ MySQL API**: 数据库操作接口
- **多进程架构**: 房间管理系统
- **线程池**: 并发处理
- **SSH反向隧道**: 内网穿透技术

### 安全技术

- **SHA256**: 密码加密存储
- **Token机制**: 会话管理和无密码认证
- **SQL预处理**: 防注入攻击
- **外键约束**: 数据一致性保证
- **权限验证**: 多角色权限控制
- **SSH加密**: 安全隧道传输

---

## 下一步计划

1. **用户登录注册与管理员审核**：解决客户端接收消息解包问题、联调管理员审核界面与后端接口、测试多角色登录流程
2. **音视频通信功能优化**：集成Opus音频编码库和H.264视频编码库，实现PCM到Opus、JPEG到H.264的转换，开发自适应比特率控制，优化网络传输效率
3. **多画面视频会议系统**：开发多画面布局管理、视频墙模式、主画面切换、发言人检测等功能，支持多人视频会议
4. **心跳机制与自动重连**：优化重连策略，增加网络抖动适应性
5. **实时显示工厂设备信息功能的开发**：开发压力、温度曲线、日志、故障信息等实时显示功能。
6. **代码整合与协议统一**：合并多版本代码，整合接口，清理重复实现并保证完整编译通过
7. **系统集成测试**： 全面测试所有功能模块的集成
8. **文档完善、项目答辩准备**：编写用户手册和部署文档，准备演示和答辩材料

---
