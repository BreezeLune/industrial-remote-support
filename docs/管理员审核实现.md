### 整体实现思路（管理员审核界面）
- 客户端新增一个独立窗口组件 `client/adminpanel.{h,cpp,ui}` 作为“管理员审核页面”，不改动原有 UI 风格，只扩展功能。
- 管理员登录后不再进入主界面 `Widget`，而是只打开 `AdminPanel`，避免“弹两个界面”。
- 审核页通过已建立的 TCP 连接与服务端通讯。客户端不直接连数据库，所有用户数据与审核操作都由服务端执行并以 JSON 返回。
- 前后端新增并统一了管理员相关协议消息：
  - 请求：`GET_PENDING_USERS(60)`, `APPROVE_USER(61)`, `REJECT_USER(62)`
  - 响应：`GET_PENDING_USERS_RESPONSE(63)`, `APPROVE_USER_RESPONSE(64)`, `REJECT_USER_RESPONSE(65)`

### 客户端改动与流程
- 登录跳转与连接复用
  - 在 `client/dialog.cpp` 的登录成功回调 `onLoginSuccess` 中：当角色为 `"admin"` 时，创建 `AdminPanel`，传入同一个 `MyTcpSocket`，关闭登录框。这样管理员审核页沿用登录时的 TCP 连接，不会断开重连，也不会弹出主页面。
- 审核页 UI 与行为
  - 文件：`client/adminpanel.ui`（表格、筛选、刷新、审核通过/拒绝按钮）
  - 行为：
    - 显示时自动请求数据：`AdminPanel::showAdminPanel()` → `loadPendingUsers()` → 发送 `GET_PENDING_USERS`
    - 审核操作：确认后发送 `APPROVE_USER` 或 `REJECT_USER`
    - 自动刷新：定时器每 30 秒拉取一次
    - 列表填充：插入前临时关闭排序，填充后恢复，避免“行错乱”。选择行时通过第0列“用户ID”与列表匹配，避免排序导致的索引错位
    - “审核人ID”列已应你要求完全移除（不再显示）
- Socket 消息接入
  - 在 `client/mytcpsocket.cpp` 的接收函数中，当收到 `63/64/65` 时，直接发射信号 `adminMessage(type, payload)` 给 `AdminPanel`
  - `AdminPanel::setTcpSocket` 中连接该信号到 `handleServerResponse`
- 管理员 ID 注入
  - 服务端登录成功改为返回“角色|用户ID”，客户端在 `AUTH_OK_ADMIN` 解析出 `adminId`，通过 `adminLogin(adminId)` 信号传给 `AdminPanel` 的 `setCurrentUserId`。同时在 `MyTcpSocket` 缓存 `m_lastAdminId`，在 `Dialog` 中兜底再设置一次，防止信号先于界面连接丢失。
  - 审核请求体会携带 `{"userId":X,"adminId":Y}`

### 服务端改动与流程
- 消息处理入口：`server/userdeal.cpp`
  - 登录 `AUTH_B`：调用 `authenticateUser(...)`，登录成功返回 `AUTH_OK_*`；Admin 情况下负载为 `"admin|<userId>"`
  - 管理员请求：
    - `GET_PENDING_USERS`：查询用户并返回 JSON。应你的需求已过滤掉 `role == "admin"`，避免管理员显示在列表中（如要只看待审核，可改成 `getPendingUser()`）
    - `APPROVE_USER`/`REJECT_USER`：解析 `userId/adminId`，调用 `approveUser/rejectUser`，返回 `{ok:true/false,error?:...}`
- 数据库访问：`server/auth.cpp`
  - 连接参数在文件顶部（HOST/USER/PASS/DB_NAME/PORT），你可配置成云库或本地库
  - 注册 `registerUser`、登录 `authenticateUser`：
    - 登录增加了 `status` 检查：若 `status == "rejected"`，拒绝登录（`USER_REJECTED`）
  - 审核：
    - `approveUser/rejectUser` 只允许从 `"pending"` 状态修改为 `"approved"`/`"rejected"`（SQL 增加 `AND status='pending'`，并用受影响行数判断是否成功，防止重复审核）
  - 列表返回：
    - `getAllUsers()` 现在会取 `IFNULL(reviewed_by,0)` 并包含在 JSON 中（客户端目前隐藏该列展示）

### 你提出的问题与原因解释
- 为什么管理员审核页最初没数据？
  - 原因1：服务端运行的是旧进程，未包含 60~65 管理员消息处理逻辑，日志出现“unsupported 60”。重启为最新编译的 server 后解决
  - 原因2：你切到只展示非管理员/或仅待审核时，库里没有符合条件的记录，返回空列表
- 列表“行错乱/选中与弹窗不一致”？
  - 因为表格启用排序时，边填充边排序导致行位置变化。已改为“填充前禁用排序、填充完再恢复”，并用第0列“用户ID”做匹配，彻底避免错位
- 登录管理员时弹出两个界面？
  - 已改为管理员登录仅打开 `AdminPanel`，不再显示主界面
- 为什么审核后“审核人ID”没显示？
  - 原因1：云/本地库的 `users` 表可能没有 `reviewed_by` 列。服务端虽写入，查询/返回可能缺字段。我们已在代码里支持该字段，但应你要求，前端现已移除“审核人ID”列的显示
- 为什么被拒绝的用户还可登录？
  - 已在登录逻辑里增加 `status` 检查：`rejected` 拒绝登录；`pending` 可根据需求决定是否允许。目前实现允许登录（如要禁止，改为 `status!='approved'` 时拒绝）

### 云库 vs 本地库
- 当前连接的是云库（你在 `server/auth.cpp` 的 HOST/USER/PASS/DB_NAME 填的是云端参数）
- 若你要连本地：把 `HOST` 改为 `127.0.0.1` 并重启 server；若回云库，把 HOST 改回云地址，确保云 MySQL 放行你的服务器出口 IP 和 3306 端口

### 日志与自检
- 客户端：
  - “[AdminPanel] handleServerResponse: type=63 bytes=...”，随后 “[AdminPanel] users loaded= X”、“updateTableData rows= X” 说明渲染链路正常
- 服务端：
  - 收到 60/61/62 不应再出现 “unsupported 60”，否则是旧进程；确认只启动了新编译的 `./app`

### 当前状态与定制项
- 审核人列已移除显示，审核仍会走服务端逻辑
- 管理员账号不会出现在审核列表
- 已审核的记录不会被重复审核，客户端也会在 UI 上拦截
- 若要只显示“待审核”：
  - `server/userdeal.cpp` 中将 `getAllUsers()` 改为 `getPendingUser()`（已在代码中留有注释位置）


### 实现逻辑：管理员审核
- 管理员登录成功 → 进入管理员审核页（AdminPanel）→ 自动拉取用户列表 → 筛选（全部/待审核/已通过/已拒绝）→ 选择用户 → 审核通过/拒绝 → 发送审核请求 → 服务端写库 → 返回结果 → 刷新UI

- 详细步骤
  1) 进入审核页
     - Dialog 收到登录成功且角色为 admin，仅创建并显示 `AdminPanel`，不会打开主界面 `Widget`
     - 复用已建立的 TCP 连接（不重新连接）
  2) 自动加载数据
     - AdminPanel 显示时调用 `loadPendingUsers()`，发送 `GET_PENDING_USERS` 请求
     - 列表填充前临时禁用排序、填充后恢复，选中逻辑以第0列“用户ID”为准，避免因排序导致选中错位
  3) 审核操作
     - 点击“审核通过/审核拒绝”→ 弹确认框 → 发送 `APPROVE_USER/REJECT_USER`，请求体包含 `userId`（被审核用户）和 `adminId`（管理员）
  4) 服务端处理
     - GET：查询用户（已过滤管理员账号），返回 JSON 列表
     - 审核：只允许从 `pending` 改为 `approved/rejected`；若已审核，返回失败
  5) UI 更新
     - 收到响应后，弹出操作结果提示；成功时自动刷新列表

### 关键点
- 消息协议
  - 请求：`GET_PENDING_USERS(60)`, `APPROVE_USER(61)`, `REJECT_USER(62)`
  - 响应：`GET_PENDING_USERS_RESPONSE(63)`, `APPROVE_USER_RESPONSE(64)`, `REJECT_USER_RESPONSE(65)`
- 角色来源与连接复用
  - 登录成功（`AUTH_OK_ADMIN`）后直接打开 AdminPanel，复用同一个 `MyTcpSocket`，管理员审核页不再断链
- 管理员ID传递
  - 服务端登录成功返回“角色|用户ID”；客户端解析出 `adminId`，经信号或兜底缓存注入 `AdminPanel::setCurrentUserId`，后续审核请求携带 `adminId`
- 列表展示与一致性
  - 填充时禁用排序、填充后恢复；选中通过第0列表格“用户ID”匹配数据源，避免排序下的索引错位
  - 审核人ID列已移除显示（按你要求）；后台仍可按需记录
- 审核幂等与安全
  - 服务端 `approveUser/rejectUser` 仅允许对 `status='pending'` 的记录生效（SQL 附带 AND 条件，受影响行数为 0 视为已审核）
  - 登录增加 `status` 校验：`rejected` 拒绝登录；（如需禁止 `pending` 登录，可改）

### 相关代码文件
- 客户端
  - `client/dialog.cpp`：管理员登录成功仅打开 `AdminPanel`；传递/兜底设置 `adminId`
  - `client/adminpanel.h/.cpp/.ui`：审核页 UI、拉取/筛选/审核逻辑，发送与处理协议 60~65
  - `client/mytcpsocket.h/.cpp`：新增 `adminMessage(int,QByteArray)` 分发管理员响应；在 `AUTH_OK_ADMIN` 解析并缓存 `adminId`，发出 `adminLogin` 信号
  - `client/netheader.h`：定义协议枚举（60~65）
- 服务端
  - `server/userdeal.cpp`（`dowithuser`）：
    - 处理 `GET_PENDING_USERS/APPROVE_USER/REJECT_USER`，过滤管理员账号，不重复审核
    - 登录成功时返回“角色|用户ID”
  - `server/auth.cpp`：
    - 数据库读取/写入：`getAllUsers()/getPendingUser()`，`approveUser()/rejectUser()`，`authenticateUser()`
    - 登录校验增加 `status` 检查：`rejected` 拒绝登录
  - `server/UserInfo.h`：用户结构（id/username/email/company/role/status/...）

说明
- 切换云库/本地库：修改 `server/auth.cpp` 顶部的 `HOST/USER/PASS/DB_NAME/PORT`，重启 server
- 只展示“待审核”用户：`userdeal.cpp` 的 GET 处理改用 `getPendingUser()` 即可


修改时的回答:

我将给管理员审核页关键路径加上 qDebug 日志（接收、解析、填充、筛选、发送请求等），并修正登录界面里对空 socket 的 connect 警告。随后你可重新运行并查看控制台输出定位问题。


- 我已在管理员审核页加上调试日志，覆盖收发与渲染关键路径：
  - AdminPanel::setTcpSocket: “[AdminPanel] TcpSocket set & signal connected”
  - showAdminPanel/loadPendingUsers/sendGetPendingUsersRequest
  - handleServerResponse: 打印 type 与 bytes；解析完打印 “users loaded=...”
  - updateTableData: 打印 “rows=...”
  - 审核通过/拒绝请求时也会打印 payload

请重新编译运行后，观察控制台是否出现如下两行：
- [AdminPanel] handleServerResponse: type= 63 bytes= NNN
- [AdminPanel] users loaded= X 和 [AdminPanel] updateTableData rows= X

如果 X>0 且 rows>0，表格就应显示数据；若 X>0 但表格仍空，我再把初始化时直接调用一次 updateTableData(m_allUsers) 以绕过筛选器影响。

关于“管理员如何连接数据库？”
- 管理员审核页不会直接连数据库，它复用登录时建立的 TCP 连接，通过消息与服务端交互，服务端在虚拟机内访问数据库并返回 JSON。
- 在我们当前实现里，管理员登录成功后不会断开 TCP 连接：Dialog 中 admin 分支直接把 m_tcpSocket 传给 AdminPanel，AdminPanel 用该 socket 发送 GET_PENDING_USERS/APPROVE_USER/REJECT_USER。
- 只有非管理员登录后才按你原有策略断开连接并进入主页面（主页面再手动输入 IP/端口去连）。

顺手建议
- 你日志里的 “QObject::connect(MyTcpSocket, Dialog): invalid nullptr parameter” 来自 Dialog 构造函数对空指针 m_tcpSocket 的 connect。可将这些 connect 全部移到 Dialog::setTcpSocket 里（我们已这么做管理员用的信号），或在构造函数中先 if(m_tcpSocket) 再 connect，消除警告，不影响功能。

接下来你只需：
- 重编 client，运行后看 “[AdminPanel] users loaded=” 和 “updateTableData rows=”。把这两行发我（若 rows=0）我再做微调确保 UI 刷新到表格。


我将修复管理员表格的行错乱与选择错位：在填充表格时临时禁用排序、填充完成后再启用；并在审核时以选中行的用户ID匹配数据源，避免排序导致的索引错位。随后我会直接修改 `client/adminpanel.h/.cpp`。

[4 tools called]

- 我已修复表格行错乱与选择错位：
  - 填充前禁用排序、清空内容，填充完再恢复排序，避免插入过程中排序导致的错位。
  - 审核时不再用当前行索引直接访问数据，而是读取选中行第0列的用户ID，在当前筛选后的列表里匹配到真正的用户对象，确保弹窗信息与操作目标一致。

请重新编译运行并测试：
- 查看控制台应仍能看到 “[AdminPanel] updateTableData rows= ...”
- 选择某行点审核，弹窗用户名应与表格选中一致，排序任意切换也不会错位。

- 数据来源说明
  - 管理员页面不会直连数据库。它通过 TCP 发送 GET_PENDING_USERS 到服务端。
  - 服务端在 `server/userdeal.cpp` 中调用获取用户列表的函数（当前是 `getAllUsers()`），而数据库连接参数定义在 `server/auth.cpp` 顶部：
    - `HOST = "39.106.12.91"`、`USER = "qtuser"`、`PASS = "QtPassw0rd!"`、`DB_NAME = "dongRuanSystem"`
  - 所以你现在看到的“20 个用户”来自这台云 MySQL，而不是你虚拟机里只建了 5 个用户的本地库。

- 切换为虚拟机本地数据库
  1) 编辑 `server/auth.cpp` 顶部四个常量，把 `HOST` 改为你虚拟机的 MySQL 地址（如 `127.0.0.1` 或实际内网 IP），同时改成你本地库的用户名/密码/数据库名。
  2) 重新 make，重启 server。
  3) 客户端管理员页重新登录后，会看到本地库的用户数（例如 5 个）。
  - 可选：你也可以把这四个常量改为从 `db_config.h` 或环境变量读取，避免写死凭据。

- 只显示“待审核”用户（如果需要）
  - 将 `server/userdeal.cpp` 中 GET_PENDING_USERS 响应由 `getAllUsers()` 改为 `getPendingUser()`，重编后管理员页面就只会展示待审核用户。

- 快速自检
  - 修改并重启后，看客户端日志 “[AdminPanel] users loaded=” 是否变为 5。
  - 服务端也可打印当前使用的 `HOST` 来确认连接的是本地库。